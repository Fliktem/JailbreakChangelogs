class CommentsManager{constructor(t,e,n=null){return this.sortOrder=sessionStorage.getItem("commentsSort")||"newest",window.commentsManagerInstance?window.commentsManagerInstance:(this.type=t,this.itemId=e,this.itemName=n,this.currentPage=1,this.commentsPerPage=7,this.comments=[],this.currentEditingComment=null,this._isLoading=!1,this._renderTimeout=null,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{this.initializeElements()&&this.setupEventListeners()})):this.initializeElements()&&this.setupEventListeners(),window.commentsManagerInstance=this,this)}checkLoginStatus(){const t=Cookies.get("token");return this.input&&this.submitBtn?t?(this.input.disabled=!1,this.input.placeholder="Write a comment...",this.submitBtn.innerHTML='\n      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">\n\t<rect width="24" height="24" fill="none" />\n\t<g fill="none">\n\t\t<path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z" />\n\t\t<path fill="#fff" d="M20.235 5.686c.432-1.195-.726-2.353-1.921-1.92L3.709 9.048c-1.199.434-1.344 2.07-.241 2.709l4.662 2.699l4.163-4.163a1 1 0 0 1 1.414 1.414L9.544 15.87l2.7 4.662c.638 1.103 2.274.957 2.708-.241z" />\n\t</g>\n</svg>\n        Submit\n    ',this.submitBtn.classList.add("btn-primary"),this.submitBtn.classList.remove("btn-secondary"),this.submitBtn.disabled=!1,!0):(this.input.disabled=!0,this.input.placeholder="Please login to comment",this.submitBtn.textContent="Login",this.submitBtn.classList.add("btn-secondary"),this.submitBtn.classList.remove("btn-primary"),this.submitBtn.disabled=!1,!1):(console.error("[Debug] Elements not found in checkLoginStatus"),!1)}initializeElements(){this.form=document.getElementById("comment-form"),this.sortSelect=document.getElementById("comment-sort"),this.input=document.getElementById("commenter-text"),this.submitBtn=document.getElementById("submit-comment"),this.commentsList=document.getElementById("comments-list"),this.paginationControls=document.getElementById("paginationControls"),this.commentsHeader=document.getElementById("comment-header");const t=document.getElementById("editCommentModal");return this.form&&this.input&&this.submitBtn&&this.commentsList&&this.paginationControls&&this.commentsHeader&&t?(this.editModal=new bootstrap.Modal(t),this.input.disabled=!this.checkLoginStatus(),this.input.placeholder=this.checkLoginStatus()?"Write a comment...":"Login to comment",this.sortSelect&&(this.sortSelect.value=this.sortOrder,this.sortSelect.addEventListener("change",(()=>{this.sortOrder=this.sortSelect.value,sessionStorage.setItem("commentsSort",this.sortOrder),this.renderComments()}))),!0):(console.error("[Debug] Required comment elements not found!"),!1)}setupEventListeners(){if(!this.form||!this.input||!this.submitBtn)return void console.error("[Debug] Cannot setup event listeners - elements not found");this.form.addEventListener("submit",(t=>{t.preventDefault();const e=this.input.value.trim();this.checkLoginStatus()?e&&this.submitComment():window.location.href="/login"}));const t=document.getElementById("saveCommentEdit");t&&t.addEventListener("click",(()=>this.saveEditedComment())),this.checkLoginStatus()}updateCommentsHeader(){if(!this.commentsHeader)return;let t;switch(this.type){case"changelog":t=`Comments for Changelog #${this.itemId}`;break;case"season":t=`Comments for Season ${this.itemId}`;break;case"trade":t=`Comments for Trade #${this.itemId}`;break;default:t=this.itemName?`Comments for ${this.itemName} [${this.type.charAt(0).toUpperCase()+this.type.slice(1)}]`:`Comments for ${this.type.charAt(0).toUpperCase()+this.type.slice(1)} #${this.itemId}`}this.commentsHeader.textContent=t}clearComments(){this.commentsList&&this.paginationControls?(this.comments=[],this.currentPage=1,this.commentsList.innerHTML="",this.paginationControls.style.display="none"):console.error("[Debug] Cannot clear comments - elements not initialized")}async loadComments(){if(!this._isLoading)if(this.commentsList&&this.paginationControls||(console.error("[Debug] Comments elements not initialized yet"),this.initializeElements())){if("changelog"!==this.type&&this.itemName)try{if(!(await fetch(`https://api3.jailbreakchangelogs.xyz/items/get?name=${encodeURIComponent(this.itemName)}&type=${this.type}`)).ok){const t=document.querySelector(".comment-container");return void(t&&(t.style.display="none",window.commentsManagerInstance=null))}}catch(t){return void console.error("[Debug] Error verifying item existence:",t)}this._isLoading=!0,this.clearComments(),this.commentsList.innerHTML='\n      <li class="list-group-item comments-loading">\n        <div class="spinner mb-2"></div>\n        <div>Loading comments...</div>\n      </li>\n    ';try{const t=await fetch(`https://api3.jailbreakchangelogs.xyz/comments/get?type=${this.type}&id=${this.itemId}`,{headers:{"Content-Type":"application/json",Origin:"https://jailbreakchangelogs.xyz"}});if(404===t.status)return this.commentsList.innerHTML='\n          <li class="list-group-item text-center" style="background-color: #212a31;">\n            <div class="py-3">\n           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16">\n            <rect width="16" height="16" fill="none" />\n            <path fill="#6c757d" d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4.414a1 1 0 0 0-.707.293L.854 15.146A.5.5 0 0 1 0 14.793zm5 4a1 1 0 1 0-2 0a1 1 0 0 0 2 0m4 0a1 1 0 1 0-2 0a1 1 0 0 0 2 0m3 1a1 1 0 1 0 0-2a1 1 0 0 0 0 2" />\n          </svg>\n              <p class="mb-0 text-muted">No comments yet</p>\n              <p class="small text-muted mb-0">Be the first to share your thoughts!</p>\n            </div>\n          </li>\n        ',this._isLoading=!1,void(this.paginationControls.style.display="none");if(!t.ok)throw new Error("Failed to fetch comments");const e=await t.json();this.comments=e,this.renderComments()}catch(t){console.error("[CommentsManager] Error loading comments:",t),"rate_limit"===t.message||429===response?.status?(this.commentsList.innerHTML='\n          <li class="list-group-item text-center text-warning">\n           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">\n            <rect width="24" height="24" fill="none" />\n            <path fill="currentColor" fill-rule="evenodd" d="M13.164 3.492a2.92 2.92 0 0 0-2.328 0c-.506.22-.881.634-1.222 1.115c-.338.477-.711 1.123-1.173 1.923l-4.815 8.34c-.438.758-.794 1.374-1.026 1.881c-.235.51-.4 1.025-.336 1.558c.095.782.526 1.48 1.175 1.929c.438.303.97.411 1.543.462c.57.05 1.3.05 2.205.05h9.626c.905 0 1.635 0 2.205-.05c.573-.05 1.105-.16 1.543-.462a2.75 2.75 0 0 0 1.175-1.929c.065-.533-.102-1.047-.336-1.558c-.232-.507-.588-1.123-1.026-1.882l-4.815-8.34c-.462-.799-.835-1.445-1.173-1.922c-.34-.48-.716-.894-1.222-1.115M10.756 9.4C10.686 8.65 11.264 8 12 8s1.313.649 1.244 1.4l-.494 4.15a.76.76 0 0 1-.75.7a.76.76 0 0 1-.75-.7zm2.494 7.35a1.25 1.25 0 1 1-2.5 0a1.25 1.25 0 0 1 2.5 0" clip-rule="evenodd" />\n          </svg>\n            You\'re being rate limited. Please wait a moment before trying again.\n          </li>\n        ',notyf.warning("You're being rate limited. Please wait a moment before trying again.","Rate Limit")):(this.commentsList.innerHTML='\n          <li class="list-group-item text-center text-danger">\n          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">\n            <rect width="24" height="24" fill="none" />\n            <path fill="currentColor" fill-rule="evenodd" d="M13.164 3.492a2.92 2.92 0 0 0-2.328 0c-.506.22-.881.634-1.222 1.115c-.338.477-.711 1.123-1.173 1.923l-4.815 8.34c-.438.758-.794 1.374-1.026 1.881c-.235.51-.4 1.025-.336 1.558c.095.782.526 1.48 1.175 1.929c.438.303.97.411 1.543.462c.57.05 1.3.05 2.205.05h9.626c.905 0 1.635 0 2.205-.05c.573-.05 1.105-.16 1.543-.462a2.75 2.75 0 0 0 1.175-1.929c.065-.533-.102-1.047-.336-1.558c-.232-.507-.588-1.123-1.026-1.882l-4.815-8.34c-.462-.799-.835-1.445-1.173-1.922c-.34-.48-.716-.894-1.222-1.115M10.756 9.4C10.686 8.65 11.264 8 12 8s1.313.649 1.244 1.4l-.494 4.15a.76.76 0 0 1-.75.7a.76.76 0 0 1-.75-.7zm2.494 7.35a1.25 1.25 0 1 1-2.5 0a1.25 1.25 0 0 1 2.5 0" clip-rule="evenodd" />\n          </svg>\n            Failed to load comments. Please try again.\n          </li>\n        ',t.message.includes("404")||notyf.error("Failed to load comments. Please try again."))}finally{this._isLoading=!1}}else console.error("[Debug] Failed to initialize elements")}async renderComments(){this._renderTimeout&&clearTimeout(this._renderTimeout);const t=this.commentsList.offsetHeight;this.commentsList.style.minHeight=`${t}px`;try{const t='\n        <li class="list-group-item comments-loading">\n          <div class="spinner mb-2"></div>\n          <div>Loading comments...</div>\n        </li>\n      ';if(this.commentsList.innerHTML=t,this.commentsList.innerHTML="",0===this.comments.length)return this.commentsList.innerHTML='\n          <li class="list-group-item text-center" style="background-color: #212a31;">\n              <div class="py-3">\n                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16">\n                  <rect width="16" height="16" fill="none" />\n                  <path fill="#6c757d" d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4.414a1 1 0 0 0-.707.293L.854 15.146A.5.5 0 0 1 0 14.793zm5 4a1 1 0 1 0-2 0a1 1 0 0 0 2 0m4 0a1 1 0 1 0-2 0a1 1 0 0 0 2 0m3 1a1 1 0 1 0 0-2a1 1 0 0 0 0 2" />\n                </svg>\n                <p class="mb-0 text-muted">No comments yet</p>\n                <p class="small text-muted mb-0">Be the first to share your thoughts!</p>\n              </div>\n          </li>\n        ',void(this.paginationControls.style.display="none");const e=[...this.comments].sort(((t,e)=>{const n=parseInt(t.date),i=parseInt(e.date);return"newest"===this.sortOrder?i-n:n-i})),n=Math.ceil(e.length/this.commentsPerPage),i=(this.currentPage-1)*this.commentsPerPage,s=i+this.commentsPerPage,o=e.slice(i,s),a=await Promise.all(o.map((t=>this.generateCommentHTML(t)))),r=document.createElement("div");r.innerHTML=a.join("");const l=r.children,c=document.createDocumentFragment();Array.from(l).forEach(((t,e)=>{const n=o[e],i=t.querySelector(".comment-text"),s=t.querySelector(".show-more-btn");i&&s&&(c.appendChild(t),this.commentsList.appendChild(c),i.scrollHeight>300&&(i.classList.add("truncated"),s.classList.add("visible")),s.addEventListener("click",(()=>{const t=i.classList.contains("expanded");i.classList.toggle("expanded"),i.classList.toggle("truncated"),s.textContent=t?"Show more":"Show less"}))),t.querySelector(".comment-actions")&&this.setupCommentActions(t,n)})),n>1?(this.renderPagination(n),this.paginationControls.style.display="flex"):this.paginationControls.style.display="none"}catch(t){console.error("Error rendering comments:",t),this.commentsList.innerHTML='\n        <li class="list-group-item text-center text-danger">\n          Error loading comments. Please try again.\n        </li>\n      '}finally{setTimeout((()=>{this.commentsList.style.minHeight=""}),300)}}async generateCommentHTML(t){const e=Cookies.get("token");let n=!1,i=null;try{if(t.user_id&&(i=await this.fetchUserDetails(t.user_id)),e){const i=await fetch(`https://api3.jailbreakchangelogs.xyz/users/get/token?token=${e}`);if(i.ok){n=(await i.json()).id===t.user_id}}}catch(t){console.error("Error generating comment HTML:",t)}const s=i&&"None"!==i.global_name?i.global_name:i?i.username:t.author,o=i?.isDeleted?`<span class="comment-author text-muted">${s}</span>`:`<a href="/users/${t.user_id}" class="comment-author">${s}</a>`,a=t=>new Date(1e3*t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),r=t.edited_at?`Last edited ${a(t.edited_at)}`:a(t.date),l=`https://ui-avatars.com/api/?background=134d64&color=fff&size=128&rounded=true&name=${encodeURIComponent(s)}&bold=true&format=svg`,c=i?.isDeleted?`<div class="rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: #134d64;">${i.avatar}</div>`:`<img src="${await window.checkAndSetAvatar(i)}" \n          class="rounded-circle me-2" \n          width="40" \n          height="40"\n          onerror="this.src='${l}'"\n          alt="${s}'s avatar">`;return`\n      <li class="list-group-item comment-item" data-comment-id="${t.id}">\n        <div class="d-flex align-items-start">\n          ${c}\n          <div class="flex-grow-1">\n            <div class="d-flex justify-content-between align-items-center">\n              <div>\n                <h6 class="mb-0">\n                  ${o}\n                </h6>\n                <small class="text-muted">\n                  ${r}\n                </small>\n              </div>\n              ${n?this.generateActionButtons():""}\n            </div>\n            <div class="comment-content">\n              <p class="comment-text mb-0">${this.escapeHtml(t.content)}</p>\n              <button class="show-more-btn">Show more</button>\n            </div>\n          </div>\n        </div>\n      </li>\n    `}generateActionButtons(){return'\n      <div class="comment-actions">\n        <button class="comment-actions-toggle" aria-label="Comment actions">\n          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">\n            <rect width="16" height="16" fill="none" />\n            <path fill="currentColor" d="M9.5 13a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0" />\n          </svg>\n        </button>\n        <div class="comment-actions-menu d-none">\n          <button class="comment-action-item edit-comment">\n            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">\n              <rect width="24" height="24" fill="none" />\n              <path fill="currentColor" d="m14.06 9.02l.92.92L5.92 19H5v-.92zM17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83l3.75 3.75l1.83-1.83a.996.996 0 0 0 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29m-3.6 3.19L3 17.25V21h3.75L17.81 9.94z" />\n            </svg>Edit\n          </button>\n          <button class="comment-action-item delete-comment delete">\n            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">\n              <rect width="24" height="24" fill="none" />\n              <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16m-10 4v6m4-6v6M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-12M9 7V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3" />\n            </svg>Delete\n          </button>\n        </div>\n      </div>\n    '}async renderCommentItem(t){const e=Cookies.get("token");let n=!1,i=null;if(t.user_id)try{i=await this.fetchUserDetails(t.user_id)}catch(t){console.error("Error fetching user details:",t)}const s=i&&"None"!==i.global_name?i.global_name:i?i.username:t.author,o=i?.isDeleted?`<span class="comment-author text-muted">${s}</span>`:`<a href="/users/${t.user_id}" class="comment-author">${s}</a>`;if(e)try{const i=await fetch(`https://api3.jailbreakchangelogs.xyz/users/get/token?token=${e}`);if(i.ok){n=(await i.json()).id===t.user_id}}catch(t){console.error("Error verifying comment ownership:",t)}const a=t=>new Date(1e3*t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),r=t.edited_at?`Last edited ${a(t.edited_at)}`:a(t.date),l=`https://ui-avatars.com/api/?background=134d64&color=fff&size=128&rounded=true&name=${encodeURIComponent(s)}&bold=true&format=svg`,c=document.createElement("li");c.className="list-group-item comment-item",c.dataset.commentId=t.id;const m=i?.isDeleted?`<div class="rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: #134d64;">${i.avatar}</div>`:`<img src="${await window.checkAndSetAvatar(i)}" \n          class="rounded-circle me-2" \n          width="40" \n          height="40"\n          onerror="this.src='${l}'"\n          alt="${s}'s avatar">`;c.innerHTML=`\n    <div class="d-flex align-items-start">\n        ${m}\n        <div class="flex-grow-1">\n            <div class="d-flex justify-content-between align-items-center">\n                <div>\n                    <h6 class="mb-0">\n                     ${o}\n                    </h6>\n                    <small class="text-muted">\n                        ${r}\n                    </small>\n                </div>\n                ${n?'\n                    <div class="comment-actions">\n                        <button class="comment-actions-toggle" aria-label="Comment actions">\n                       <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">\n\t<rect width="16" height="16" fill="none" />\n\t<path fill="currentColor" d="M9.5 13a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0a1.5 1.5 0 0 1 3 0" />\n</svg>\n                        </button>\n                        <div class="comment-actions-menu d-none">\n                            <button class="comment-action-item edit-comment">\n                               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">\n\t<rect width="24" height="24" fill="none" />\n\t<path fill="currentColor" d="m14.06 9.02l.92.92L5.92 19H5v-.92zM17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83l3.75 3.75l1.83-1.83a.996.996 0 0 0 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29m-3.6 3.19L3 17.25V21h3.75L17.81 9.94z" />\n</svg>Edit\n                            </button>\n                            <button class="comment-action-item delete-comment delete">\n                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">\n\t<rect width="24" height="24" fill="none" />\n\t<path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16m-10 4v6m4-6v6M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-12M9 7V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3" />\n</svg>Delete\n                            </button>\n                        </div>\n                    </div>\n                ':""}\n            </div>\n            <div class="comment-content">\n                <p class="comment-text mb-0">${this.escapeHtml(t.content)}</p>\n                <button class="show-more-btn">Show more</button>\n            </div>\n        </div>\n    </div>\n    `;const d=c.querySelector(".comment-text"),h=c.querySelector(".show-more-btn");setTimeout((()=>{d.scrollHeight>300&&(d.classList.add("truncated"),h.classList.add("visible"))}),10),h.addEventListener("click",(()=>{const t=d.classList.contains("expanded");d.classList.toggle("expanded"),d.classList.toggle("truncated"),h.textContent=t?"Show more":"Show less"})),n&&this.setupCommentActions(c,t),this.commentsList.appendChild(c)}async fetchUserDetails(t){try{const e=await fetch(`https://api3.jailbreakchangelogs.xyz/users/get/?id=${t}`);if(404===e.status)return{username:"Deleted User",global_name:"Deleted User",id:t,avatar:'<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 32 32">\n\t<rect width="32" height="32" fill="none" />\n\t<path fill="none" d="M8.007 24.93A4.996 4.996 0 0 1 13 20h6a4.996 4.996 0 0 1 4.993 4.93a11.94 11.94 0 0 1-15.986 0M20.5 12.5A4.5 4.5 0 1 1 16 8a4.5 4.5 0 0 1 4.5 4.5" />\n\t<path fill="currentColor" d="M26.749 24.93A13.99 13.99 0 1 0 2 16a13.9 13.9 0 0 0 3.251 8.93l-.02.017c.07.084.15.156.222.239c.09.103.187.2.28.3q.418.457.87.87q.14.124.28.242q.48.415.99.782c.044.03.084.069.128.1v-.012a13.9 13.9 0 0 0 16 0v.012c.044-.031.083-.07.128-.1q.51-.368.99-.782q.14-.119.28-.242q.451-.413.87-.87c.093-.1.189-.197.28-.3c.071-.083.152-.155.222-.24ZM16 8a4.5 4.5 0 1 1-4.5 4.5A4.5 4.5 0 0 1 16 8M8.007 24.93A4.996 4.996 0 0 1 13 20h6a4.996 4.996 0 0 1 4.993 4.93a11.94 11.94 0 0 1-15.986 0" />\n</svg>',isDeleted:!0};if(!e.ok)throw new Error("Failed to fetch user details");return await e.json()}catch(t){return void console.error("Error fetching user details:",t)}}renderPagination(t){if(t<=1)return void(this.paginationControls.style.display="none");this.paginationControls.style.display="flex";let e=[];const n=Math.floor(2.5);if(t<=5)e=Array.from({length:t},((t,e)=>e+1));else{let i=Math.max(this.currentPage-n,1),s=Math.min(i+5-1,t);s===t&&(i=Math.max(s-5+1,1)),e=Array.from({length:s-i+1},((t,e)=>i+e)),i>1&&(e.unshift(1),i>2&&e.splice(1,0,"...")),s<t&&(s<t-1&&e.push("..."),e.push(t))}this.paginationControls.innerHTML=`\n      <button class="btn btn-sm btn-primary pagination-btn me-2" \n              ${1===this.currentPage?"disabled":""}>\n        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">\n          <rect width="24" height="24" fill="none" />\n          <path fill="currentColor" d="m14 18l-6-6l6-6l1.4 1.4l-4.6 4.6l4.6 4.6z" />\n        </svg>\n      </button>\n      ${e.map((t=>"..."===t?'<span class="px-2">...</span>':`\n          <button class="btn btn-sm ${this.currentPage===t?"btn-primary":"btn-outline-primary"} mx-1"\n                  ${this.currentPage===t?"disabled":""}>\n            ${t}\n          </button>\n        `)).join("")}\n      <button class="btn btn-sm btn-primary pagination-btn ms-2" \n              ${this.currentPage===t?"disabled":""}>\n        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">\n          <rect width="24" height="24" fill="none" />\n          <path fill="currentColor" d="M12.6 12L8 7.4L9.4 6l6 6l-6 6L8 16.6z" />\n        </svg>\n      </button>\n    `;const[i,...s]=this.paginationControls.querySelectorAll("button"),o=s.pop();i.addEventListener("click",(()=>this.changePage(this.currentPage-1))),o.addEventListener("click",(()=>this.changePage(this.currentPage+1))),s.forEach((t=>{const e=parseInt(t.textContent);isNaN(e)||t.addEventListener("click",(()=>this.changePage(e)))}))}changePage(t){t<1||t>Math.ceil(this.comments.length/this.commentsPerPage)||(this.currentPage=t,this.renderComments())}setupCommentActions(t,e){const n=t.querySelector(".comment-actions-toggle"),i=t.querySelector(".comment-actions-menu"),s=t.querySelector(".edit-comment"),o=t.querySelector(".delete-comment");n&&i&&s&&o?(n.addEventListener("click",(t=>{t.stopPropagation(),document.querySelectorAll(".comment-actions-menu").forEach((t=>{t!==i&&t.classList.add("d-none")})),i.classList.toggle("d-none")})),document.addEventListener("click",(()=>{i.classList.add("d-none")})),s&&s.addEventListener("click",(()=>this.editComment(e))),o&&o.addEventListener("click",(()=>this.deleteComment(e.id)))):console.warn("[Debug] Missing some action elements for comment:",e.id)}escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}async submitComment(){if(!this.input)return void console.error("[Debug] Input element not found");const t=this.input.value.trim();if(!t)return;const e=Cookies.get("token");if(e)try{const n=await fetch(`https://api3.jailbreakchangelogs.xyz/users/get/token?token=${e}`);if(!n.ok)throw console.error("[Debug] Failed to get user data:",n.status),new Error("Failed to get user data");const i=await n.json(),s={author:i.username,content:t,item_id:this.itemId,item_type:this.type,user_id:i.id,owner:e},o=await fetch("https://api3.jailbreakchangelogs.xyz/comments/add",{method:"POST",headers:{"Content-Type":"application/json",Origin:"https://jailbreakchangelogs.xyz"},body:JSON.stringify(s)});if(!o.ok){if(429===o.status)throw new Error("rate_limit");throw new Error("Failed to submit comment")}this.input.value="",await this.loadComments(),notyf.success("Comment added successfully")}catch(t){console.error("[Debug] Error in submitComment:",t),"rate_limit"===t.message||429===t.response?.status?notyf.warning("You're being rate limited. Please wait a moment before trying again.","Rate Limit"):notyf.error("Failed to post comment. Please try again.")}else console.error("[Debug] No token found, submission cancelled")}async deleteComment(t){const e=Cookies.get("token");if(e&&confirm("Are you sure you want to delete this comment?"))try{const n=await fetch(`https://api3.jailbreakchangelogs.xyz/users/get/token?token=${e}`);if(!n.ok)throw new Error("Failed to get user data");await n.json();if(!(await fetch("https://api3.jailbreakchangelogs.xyz/comments/delete",{method:"DELETE",headers:{"Content-Type":"application/json",Origin:"https://jailbreakchangelogs.xyz"},body:JSON.stringify({id:String(t),author:e})})).ok)throw new Error("Failed to delete comment");notyf.success("Comment deleted successfully"),await this.loadComments()}catch(t){console.error("Error deleting comment:",t),notyf.error("Failed to delete comment. Please try again.")}}editComment(t){if(!this.editModal)return void console.error("[Debug] Edit modal not initialized");const e=document.getElementById("editCommentText");e?(this.currentEditingComment=t,e.value=t.content,this.editModal.show()):console.error("[Debug] Edit comment text area not found")}async saveEditedComment(){if(!this.currentEditingComment)return;if(!this.editModal)return void console.error("[Debug] Edit modal not initialized");const t=Cookies.get("token");if(!t)return;if(!document.getElementById("editCommentText"))return void console.error("[Debug] Edit comment text area not found");const e=document.getElementById("editCommentText").value.trim();if(e)try{if(!(await fetch("https://api3.jailbreakchangelogs.xyz/comments/edit",{method:"POST",headers:{"Content-Type":"application/json",Origin:"https://jailbreakchangelogs.xyz"},body:JSON.stringify({id:this.currentEditingComment.id,content:e,author:t})})).ok)throw new Error("Failed to edit comment");this.editModal.hide(),notyf.success("Comment edited successfully"),await this.loadComments()}catch(t){console.error("Error editing comment:",t),notyf.error("Failed to edit comment. Please try again.")}}}